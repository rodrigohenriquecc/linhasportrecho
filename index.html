<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>CGR 02 - Sistema de Localização</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- favicon “vazio” evita 404 -->
  <link rel="icon" href="data:," />

  <!-- pré-conexão às CDNs -->
  <link rel="preconnect" href="https://unpkg.com" />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />

  <!-- JSZip, shp.js, Turf, PapaParse, toGeoJSON -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"        defer></script>
  <script src="https://cdn.jsdelivr.net/npm/shpjs@3.6.2/dist/shp.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7.2.0/turf.min.js"               defer></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"           defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js" defer></script>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"       defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js" defer></script>

  <!-- script principal -->
  <script src="assets/js/script_colaborativo.js" defer></script>

  <!-- =========== ESTILOS BÁSICOS =========== -->
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }

    /* botão flutuante (recarregar planilhas) */
    .fab{
      /* removido pois não será mais usado */
      display: none;
    }

    /* Labels das RCs */
    .rc-label{
      background:rgba(255, 255, 255, 0.5);
      color:#000000;
      padding:2px 4px;
      border-radius:3px;
      border:1px solid #555;
      font-weight:600;
      box-shadow:0 0 2px rgba(0, 0, 0, 0.35);
      white-space:nowrap;
      pointer-events:none;
      z-index:1000;
      font-size: 7px;
      letter-spacing: 0.1px;
      backdrop-filter: blur(1px);
    }

    /* ─── NOVO: cartucho branco dos nomes de rodovia ─── */
    .rod-label{
      background:rgba(255,255,255,0.85);
      color:#000;
      padding:2px 4px;
      border-radius:3px;
      border:1px solid #d0d0d0;
      font-weight:600;
      box-shadow:0 0 2px rgba(0,0,0,.35);
      white-space:nowrap;
      pointer-events:none;
      z-index:1000;
      font-size: 8px;
      letter-spacing: 0.1px;
      margin-bottom: 2px;
      margin-right: 2px;
      backdrop-filter: blur(1px);
    }
    /* Evita sobreposição dos labels de rodovia */
    .rod-label.stacked {
      position: relative;
      top: 0;
      left: 0;
      margin-bottom: 2px;
      margin-right: 2px;
      z-index: 1000;
    }

    /* Cartão de localização de Km */
    .import-card {
      position: fixed;
      bottom:20px;
      left: 12px;
      z-index: 1000;
      padding: 2px 16px 2px 16px;
      min-width: 96px;
      max-width: 130px;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: left 0.3s, bottom 0.3s;
    }
    .card-fixo-esquerda {
      left: 24px;
      bottom: 20px;
      right: auto;
      top: auto;
    }

    /* Filtro de rodovia e km */
    .filtro-rodovia-card {
      background: linear-gradient(135deg, #ffffff 0%, #f7faff 100%);
      border-radius: 14px;
      padding: 10px 14px 8px 14px;
      margin-bottom: 12px;
      box-shadow: none;
      display: flex;
      flex-direction: column;
      gap: 8px;
      border: none;
    }
    .filtro-rodovia-label {
      font-size: 15px;
      color: #1565c0;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: 0.2px;
    }
    .filtro-rodovia-select, .filtro-km-input {
      font-size: 15px;
      padding: 7px 10px;
      border-radius: 6px;
      border: 1.5px solid #90caf9;
      outline: none;
      margin-bottom: 2px;
      background: #fafdff;
      color: #0d47a1;
      transition: border 0.2s;
    }
    .filtro-rodovia-select:focus, .filtro-km-input:focus {
      border: 1.5px solid #1976d2;
      background: #e3f0ff;
    }
    .filtro-km-btn {
      background: linear-gradient(90deg, #1976d2 60%, #42a5f5 100%);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 7px 0;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 2px;
      transition: background 0.2s, box-shadow 0.2s;
      box-shadow: 0 1px 4px #1976d222;
    }
    .filtro-km-btn:hover {
      background: linear-gradient(90deg, #1251a3 60%, #1976d2 100%);
    }
    .filtro-km-link {
      font-size: 14px;
      color: #1976d2;
      text-decoration: underline;
      margin-top: 2px;
      word-break: break-all;
      display: none;
    }
    .filtro-km-link.active {
      display: block;
    }
    #msgKmProximo {
      color: #c62828;
      font-size: 13px;
      margin-bottom: 2px;
      font-weight: 600;
      letter-spacing: 0.1px;
    }

    @media (max-width: 600px) {
      .import-card {
        min-width: 180px;
        font-size: 13px;
        padding: 12px 8px 8px 8px;
        right: 8px;
        bottom: 20px;
      }
      .import-toggle-btn {
        right: 8px;
        top: 8px;
        font-size: 13px;
        padding: 6px 10px;
      }
    }
    /* ====== RESPONSIVIDADE MOBILE ====== */
    @media (max-width: 700px) {
      .import-card {
        min-width: unset;
        width: 98vw;
        left: 1vw;
        right: 1vw;
        bottom: 20px;
        padding: 10px 4vw 8px 4vw;
        font-size: 14px;
      }
      .filtro-rodovia-card {
        padding: 10px 4vw 8px 4vw;
        border-radius: 10px;
        gap: 8px;
      }
      .filtro-rodovia-select, .filtro-km-input {
        font-size: 14px;
        padding: 7px 7px;
      }
      .filtro-km-btn {
        font-size: 14px;
        padding: 7px 0;
      }
    }
    @media (max-width: 480px) {
      .import-card {
        width: 99vw;
        left: 0.5vw;
        right: 0.5vw;
        bottom: 15px;
        padding: 7px 2vw 6px 2vw;
        font-size: 13px;
      }
      .filtro-rodovia-card {
        padding: 7px 2vw 6px 2vw;
        border-radius: 7px;
        gap: 6px;
      }
      .filtro-rodovia-label {
        font-size: 13px;
      }
      .filtro-rodovia-select, .filtro-km-input {
        font-size: 13px;
        padding: 6px 5px;
      }
      .filtro-km-btn {
        font-size: 13px;
        padding: 6px 0;
      }
    }
    
    /* ====== BOTÕES DE ACESSO ÀS PLANILHAS ====== */
    .planilhas-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .btn-planilha {
      background: linear-gradient(135deg, #1976d2 0%, #42a5f5 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 600;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 3px 12px rgba(25, 118, 210, 0.3);
      transition: all 0.3s ease;
      cursor: pointer;
      min-width: 160px;
      justify-content: flex-start;
    }
    
    .btn-planilha:hover {
      background: linear-gradient(135deg, #1251a3 0%, #1976d2 100%);
      transform: translateY(-2px);
      box-shadow: 0 5px 16px rgba(25, 118, 210, 0.4);
    }
    
    .btn-planilha:active {
      transform: translateY(0px);
      box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);
    }
    
    .btn-pontos {
      background: linear-gradient(135deg, #ffffff 0%, #ffffff 100%);
      box-shadow: 0 3px 12px rgba(255, 255, 255, 0.3);
    }
    
    .btn-pontos:hover {
      background: linear-gradient(135deg, #c2185b 0%, #e91e63 100%);
      box-shadow: 0 5px 16px rgba(233, 30, 99, 0.4);
    }
    
    .btn-calor {
      background: linear-gradient(135deg, #ffffff 0%, #ffffff 100%);
      box-shadow: 0 3px 12px rgba(255, 255, 255, 0.3);
    }
    
    .btn-calor:hover {
      background: linear-gradient(135deg, #e64a19 0%, #ff5722 100%);
      box-shadow: 0 5px 16px rgba(255, 87, 34, 0.4);
    }
    
    @media (max-width: 768px) {
      .planilhas-container {
        top: 10px;
        right: 10px;
        gap: 6px;
      }
      
      .btn-planilha {
        padding: 8px 12px;
        font-size: 12px;
        min-width: 140px;
      }
    }
    
    @media (max-width: 480px) {
      .planilhas-container {
        flex-direction: row;
        flex-wrap: wrap;
        top: 8px;
        right: 8px;
        left: 8px;
        gap: 4px;
      }
      
      .btn-planilha {
        flex: 1;
        min-width: auto;
        padding: 6px 8px;
        font-size: 11px;
        justify-content: center;
      }
    }
    
    /* ====== BOTÃO DE GEOLOCALIZAÇÃO ====== */
    .geolocalizacao-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .btn-geolocalizacao {
      background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
      color: white;
      border: none;
      border-radius: 50px;
      width: 56px;
      height: 56px;
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(76, 175, 80, 0.4);
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }
    
    .btn-geolocalizacao:hover {
      background: linear-gradient(135deg, #43a047 0%, #4caf50 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
    }
    
    .btn-geolocalizacao:active {
      transform: translateY(0px);
      box-shadow: 0 2px 12px rgba(76, 175, 80, 0.4);
    }
    
    .btn-geolocalizacao.ativo {
      background: linear-gradient(135deg, #f44336 0%, #ef5350 100%);
      box-shadow: 0 4px 16px rgba(244, 67, 54, 0.4);
      animation: pulse 2s infinite;
    }
    
    .btn-geolocalizacao.ativo:hover {
      background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%);
      box-shadow: 0 6px 20px rgba(244, 67, 54, 0.5);
    }
    
    @keyframes pulse {
      0% {
        box-shadow: 0 4px 16px rgba(244, 67, 54, 0.4);
      }
      50% {
        box-shadow: 0 4px 16px rgba(244, 67, 54, 0.7), 0 0 0 10px rgba(244, 67, 54, 0.1);
      }
      100% {
        box-shadow: 0 4px 16px rgba(244, 67, 54, 0.4);
      }
    }
    
    .geolocalizacao-info {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      padding: 8px 12px;
      margin-bottom: 8px;
      box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15);
      font-size: 12px;
      color: #333;
      text-align: center;
      min-width: 160px;
      backdrop-filter: blur(5px);
      display: none;
    }
    
    .geolocalizacao-info.ativo {
      display: block;
    }
    
    @media (max-width: 768px) {
      .geolocalizacao-container {
        bottom: 15px;
        right: 15px;
      }
      
      .btn-geolocalizacao {
        width: 50px;
        height: 50px;
        font-size: 18px;
      }
      
      .geolocalizacao-info {
        font-size: 11px;
        padding: 6px 10px;
        min-width: 140px;
      }
    }
    
    @media (max-width: 480px) {
      .geolocalizacao-container {
        bottom: 12px;
        right: 12px;
      }
      
      .btn-geolocalizacao {
        width: 45px;
        height: 45px;
        font-size: 16px;
      }
      
      .geolocalizacao-info {
        font-size: 10px;
        padding: 5px 8px;
        min-width: 120px;
      }
    }

    /* Menu Hamburguer */
.menu-hamburguer-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 1100;
}
.menu-hamburguer-btn {
  background: linear-gradient(135deg, #1976d2 0%, #42a5f5 100%);
  color: white;
  border: none;
  border-radius: 50%;
  width: 48px;
  height: 48px;
  font-size: 28px;
  font-weight: 700;
  box-shadow: 0 3px 12px rgba(25, 118, 210, 0.3);
  cursor: pointer;
  transition: background 0.2s;
}
.menu-hamburguer-btn:hover {
  background: linear-gradient(135deg, #1251a3 0%, #1976d2 100%);
}
.menu-hamburguer {
  display: none;
  flex-direction: column;
  gap: 8px;
  position: absolute;
  top: 56px;
  right: 0;
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 6px 24px rgba(25, 118, 210, 0.18);
  padding: 16px 18px 14px 18px;
  min-width: 180px;
  animation: fadeInMenu 0.2s;
}
.menu-hamburguer a {
  text-decoration: none;
  color: #1976d2;
  font-size: 15px;
  font-weight: 600;
  padding: 7px 0;
  border-radius: 8px;
  transition: background 0.2s;
  display: block;
}
.menu-hamburguer a:hover {
  background: #e3f0ff;
}
.menu-hamburguer-titulo {
  font-size: 16px;
  color: #1565c0;
  font-weight: 700;
  margin-bottom: 6px;
  background: none;
  cursor: default;
}

/* Integração dos controles do mapa dentro do menu hamburguer */
.menu-hamburguer .controles-mapa.leaflet-control {
  background: #f7faff;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(25, 118, 210, 0.08);
  padding: 10px 12px;
  margin: 8px 0 0 0;
  display: flex;
  flex-direction: column;
  gap: 8px;
  border: 1px solid #e3f0ff;
}

.menu-hamburguer .controles-mapa.leaflet-control button,
.menu-hamburguer .controles-mapa.leaflet-control .leaflet-control-button {
  background: linear-gradient(135deg, #1976d2 0%, #42a5f5 100%);
  color: #fff;
  border: none;
  border-radius: 7px;
  padding: 7px 0;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s, box-shadow 0.2s;
  box-shadow: 0 1px 4px #1976d222;
  margin-bottom: 4px;
  width: 100%;
}

.menu-hamburguer .controles-mapa.leaflet-control button:hover,
.menu-hamburguer .controles-mapa.leaflet-control .leaflet-control-button:hover {
  background: linear-gradient(135deg, #1251a3 0%, #1976d2 100%);
}

.menu-hamburguer .controles-mapa.leaflet-control label {
  font-size: 13px;
  color: #1565c0;
  font-weight: 600;
  margin-bottom: 4px;
}

.menu-hamburguer .controles-mapa.leaflet-control select {
  font-size: 13px;
  padding: 6px 8px;
  border-radius: 6px;
  border: 1.5px solid #90caf9;
  background: #fafdff;
  color: #0d47a1;
  margin-bottom: 4px;
  width: 100%;
}

@media (max-width: 480px) {
  .menu-hamburguer .controles-mapa.leaflet-control {
    padding: 7px 6px;
    border-radius: 7px;
    gap: 6px;
  }
  .menu-hamburguer .controles-mapa.leaflet-control button,
  .menu-hamburguer .controles-mapa.leaflet-control .leaflet-control-button {
    font-size: 12px;
    padding: 6px 0;
  }
  .menu-hamburguer .controles-mapa.leaflet-control select {
    font-size: 12px;
    padding: 5px 6px;
  }
}

@keyframes fadeInMenu {
  from { opacity: 0; transform: translateY(-10px);}
  to { opacity: 1; transform: translateY(0);}
}
@media (max-width: 480px) {
  .menu-hamburguer-container {
    top: 8px;
    right: 8px;
  }
  .menu-hamburguer {
    min-width: 140px;
    padding: 10px 10px 8px 10px;
  }
  .menu-hamburguer-btn {
    width: 38px;
    height: 38px;
    font-size: 22px;
  }
}
  </style>
</head>

<body>
  <!-- Botões de Acesso às Planilhas -->
  <!-- <div class="planilhas-container">
    <a href="https://docs.google.com/spreadsheets/d/1Zxrq6L68fkTuygCE6yVVLOb9wU0UhoQfQHOMm_Xr8RI/edit?gid=1698628532#gid=1698628532" target="_blank" class="btn-planilha btn-pontos">
      Pontos de Interesse
    </a>
    <a href="https://docs.google.com/spreadsheets/d/1IcM6qrF9JpZlJ6c6P1pvb8O5bhmdgDz4gKCtf8V2JUg/edit?usp=drive_link" target="_blank" class="btn-planilha btn-calor">
      Mapa de Calor
    </a>
    <a href="https://docs.google.com/spreadsheets/d/1r-7wdW8IwNhDMmGJ_QoflML-Mo1wvgAuw6ILK_LFlpo/edit?usp=drive_link" target="_blank" class="btn-planilha">
      Linhas por Trecho
    </a>
  </div> -->

  <!-- Geolocalização -->
  <div class="geolocalizacao-container">
    <div id="geolocalizacaoInfo" class="geolocalizacao-info">
      <div id="geoStatus">Clique para ativar localização</div>
      <div id="geoCoordenadas" style="font-size: 10px; margin-top: 2px;"></div>
    </div>
    <button id="btnGeolocalizacao" class="btn-geolocalizacao" title="Ativar/Desativar localização em tempo real">
      📍
    </button>
  </div>

  <!-- Sidebar esquerda -->
  <!-- <div class="import-card" id="importCard">
    <div class="filtro-rodovia-card" id="filtroRodoviaCard">
      <label class="filtro-rodovia-label" for="filtroRodovia">Rodovia</label>
      <select id="filtroRodovia" class="filtro-rodovia-select">
        <option value="">Rodovia</option>
      </select>
      <label class="filtro-rodovia-label" for="filtroKm">Km</label>
      <select id="filtroKm" class="filtro-km-input" disabled>
        <option value="">Selecione o Km</option>
      </select>
      <button id="filtroKmBtn" class="filtro-km-btn" disabled>Localizar</button>
      <a id="filtroKmLink" class="filtro-km-link" href="#" target="_blank" style="display:none;"></a>
      <div id="msgKmProximo" style="display:none;"></div>
      <div id="quadroFotoKm" style="display:none;margin-top:8px;text-align:left;"></div>
    </div>
  </div> -->

  <!-- Menu Hamburguer - agora com a sidebar dentro -->
  <div class="menu-hamburguer-container">
    <button id="btnMenuHamburguer" class="menu-hamburguer-btn" title="Abrir menu">
      ☰
    </button>
    <div id="menuHamburguer" class="menu-hamburguer">
            <a href="https://docs.google.com/spreadsheets/d/1Zxrq6L68fkTuygCE6yVVLOb9wU0UhoQfQHOMm_Xr8RI/edit?gid=1698628532#gid=1698628532" target="_blank" class="btn-menu-hamburguer">
        Pontos de Interesse
      </a>
      <a href="https://docs.google.com/spreadsheets/d/1IcM6qrF9JpZlJ6c6P1pvb8O5bhmdgDz4gKCtf8V2JUg/edit?usp=drive_link" target="_blank" class="btn-menu-hamburguer">
        Mapa de Calor
      </a>
      <a href="https://docs.google.com/spreadsheets/d/1r-7wdW8IwNhDMmGJ_QoflML-Mo1wvgAuw6ILK_LFlpo/edit?usp=drive_link" target="_blank" class="btn-menu-hamburguer">
        Linhas por Trecho
      </a>
            <!-- Sidebar esquerda dentro do menu -->
      <div class="import-card" id="importCard" style="position:static;box-shadow:none;min-width:unset;max-width:unset;padding:0;margin-top:10px;">
        <div class="filtro-rodovia-card" id="filtroRodoviaCard">
          <label class="filtro-rodovia-label" for="filtroRodovia">Rodovia</label>
          <select id="filtroRodovia" class="filtro-rodovia-select">
            <option value="">Rodovia</option>
          </select>
          <label class="filtro-rodovia-label" for="filtroKm">Km</label>
          <select id="filtroKm" class="filtro-km-input" disabled>
            <option value="">Selecione o Km</option>
          </select>
          <button id="filtroKmBtn" class="filtro-km-btn" disabled>Localizar</button>
          <a id="filtroKmLink" class="filtro-km-link" href="#" target="_blank" style="display:none;"></a>
          <div id="msgKmProximo" style="display:none;"></div>
          <div id="quadroFotoKm" style="display:none;margin-top:8px;text-align:left;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- MAPA -->
  <div id="map"></div>

  <script>
function initMap () {
  console.log('🚀 initMap chamada pela API do Google Maps');
  try {
    const mapa = new google.maps.Map(document.getElementById('map'), {
      zoom: 7,
      center: { lat: -23.8, lng: -48.5 },
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      gestureHandling: 'greedy',
      zoomControl: true,
      mapTypeControl: true,
      scaleControl: true,
      streetViewControl: true,
      rotateControl: false,
      fullscreenControl: true
    });
    console.log('✅ Google Maps inicializado!');
    window.mapa = mapa;      // disponibilizar globalmente

    // Adiciona o listener para o zoom, garantindo que seja único
    google.maps.event.clearListeners(mapa, 'zoom_changed'); // Remove listeners antigos
    google.maps.event.addListener(mapa, 'zoom_changed', atualizarVisibilidadeCirculos);

    /* carrega o restante do sistema (script_google_maps.js) */
    if (typeof carregarSistemaCompleto === 'function') {
      carregarSistemaCompleto(mapa);
    } else {
      const s = document.createElement('script');
      s.src = 'archives/assets/js/script_google_maps.js';
      s.onload = () => {
        console.log('📁 script_google_maps.js carregado');
        carregarSistemaCompleto(mapa);
      };
      document.head.appendChild(s);
    }
    window.mapa = mapa;      // debug
  } catch (e) {
    console.error('❌ Erro ao inicializar mapa:', e);
  }
}
window.initMap = initMap;     // expõe global
console.log('✅ initMap definida globalmente');

// Carrega a API do Google Maps se ainda não estiver presente
const CHAVE_GOOGLE_MAPS = 'AIzaSyDktuBso1pmwaQNwKsqvb54aslwRurHB5c';
if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
  const s = document.createElement('script');
  s.src =
    `https://maps.googleapis.com/maps/api/js?key=${CHAVE_GOOGLE_MAPS}` +
    `&libraries=geometry,visualization,places,drawing` +
    `&callback=initMap&v=weekly&loading=async`;
  s.defer = s.async = true;
  document.head.appendChild(s);
}
  </script>

  <script>
    // Aguarda o carregamento do script principal e do PapaParse
    let dadosPlanilhaOficial = [];
    let rodoviasPlanilha = [];
    let kmsPorRodovia = {};
    
    // Função utilitária para exibir mensagens discretas sem sobreposição
function mostrarMensagemDiscreta(texto, tempo = 2500) {
  let msgDiv = document.getElementById('msgDiscreta');
  if (!msgDiv) {
    msgDiv = document.createElement('div');
    msgDiv.id = 'msgDiscreta';
    msgDiv.style.position = 'fixed';
    msgDiv.style.bottom = '18px';
    msgDiv.style.left = '50%';
    msgDiv.style.transform = 'translateX(-50%)';
    msgDiv.style.background = 'rgba(25, 118, 210, 0.08)';
    msgDiv.style.color = '#1976d2';
    msgDiv.style.fontSize = '13px';
    msgDiv.style.padding = '4px 16px';
    msgDiv.style.borderRadius = '8px';
    msgDiv.style.boxShadow = '0 2px 8px #1976d222';
    msgDiv.style.zIndex = '9999';
    msgDiv.style.pointerEvents = 'none';
    document.body.appendChild(msgDiv);
  }
  msgDiv.textContent = texto;
  msgDiv.style.opacity = '1';
  msgDiv.style.display = 'block';
  clearTimeout(msgDiv._hideTimeout);
  msgDiv._hideTimeout = setTimeout(() => {
    msgDiv.style.opacity = '0';
    setTimeout(() => { msgDiv.style.display = 'none'; }, 400);
  }, tempo);
}
      // Inicializa referências dos elementos após o DOM estar pronto
      var filtroKmLink = document.getElementById('filtroKmLink');
      var msgKmProximo = document.getElementById('msgKmProximo');

      // Preenche rodovias no cartão usando apenas a planilha oficial
      function preencherRodoviasFiltroOficial() {
        const select = document.getElementById('filtroRodovia');
        select.innerHTML = '<option value="">Rodovia</option>';
        if (!Array.isArray(dadosPlanilhaOficial)) return;
        // Gera lista única de rodovias da coluna SP, sem duplicidades e ordenadas
        const rodoviasUnicas = [...new Set(dadosPlanilhaOficial.map(l => l.SP?.trim()).filter(Boolean))].sort();
        rodoviasUnicas.forEach(r => {
          if (r && r.length > 0) {
            const opt = document.createElement('option');
            opt.value = r;
            opt.textContent = r;
            select.appendChild(opt);
          }
        });
      }

      // Atualiza lista de Km no cartão
      function atualizarListaKmOficial() {
        const rod = document.getElementById('filtroRodovia').value;
        const kmSelect = document.getElementById('filtroKm');
        kmSelect.innerHTML = '<option value="">Selecione o Km</option>';
        if (!rod || !Array.isArray(dadosPlanilhaOficial)) {
          kmSelect.disabled = true;
          document.getElementById('filtroKmBtn').disabled = true;
          return;
        }
        // Filtra os kms correspondentes à rodovia selecionada
        const arr = dadosPlanilhaOficial.filter(l => (l.SP?.trim() === rod) && (l['KM '] || l.Km));
        arr.forEach(p => {
          let kmNum = p['KM '] ? parseFloat(p['KM '].replace(',', '.')) : (p.Km ? parseFloat(p.Km.replace(',', '.')) : NaN);
          if (!isNaN(kmNum)) {
            const opt = document.createElement('option');
            opt.value = kmNum.toFixed(3);
            opt.textContent = kmNum.toFixed(3);
            kmSelect.appendChild(opt);
          }
        });
        kmSelect.disabled = arr.length === 0;
        document.getElementById('filtroKmBtn').disabled = arr.length === 0;
      }
      document.getElementById('filtroRodovia').addEventListener('change', atualizarListaKmOficial);

      // Exibe dados e marcador ao buscar
      document.getElementById('filtroKmBtn').addEventListener('click', function() {
        const rod = document.getElementById('filtroRodovia').value;
        const kmSelect = document.getElementById('filtroKm');
        const quadroFoto = document.getElementById('quadroFotoKm');
        quadroFoto.style.display = 'none';
        if (!rod || !kmSelect.value) {
          alert('Selecione uma rodovia e um Km válido!');
          return;
        }
        // Busca o registro correspondente (compara Km como número, busca o mais próximo se não encontrar)
        const kmSelecionado = parseFloat(kmSelect.value.toString().replace(',', '.'));
        let ponto = dadosPlanilhaOficial.find(l => {
          const rodCol = l.SP?.toString().trim();
          let kmCol = l.Km !== undefined ? l.Km : l['KM '];
          kmCol = parseFloat(kmCol?.toString().replace(',', '.'));
          return rodCol === rod && !isNaN(kmCol) && kmCol.toFixed(3) === kmSelecionado.toFixed(3);
        });
        let usouProximo = false;
        if (!ponto) {
          // Busca o mais próximo
          const arrRod = dadosPlanilhaOficial.filter(l => l.SP?.toString().trim() === rod && l.Km !== undefined || l['KM '] !== undefined);
          let pontoProx = null;
          let menorDist = Infinity;
          arrRod.forEach(l => {
            let kmCol = l.Km !== undefined ? l.Km : l['KM '];
            kmCol = parseFloat(kmCol?.toString().replace(',', '.'));
            if (!isNaN(kmCol)) {
              const dist = Math.abs(kmCol - kmSelecionado);
              if (dist < menorDist) {
                menorDist = dist;
                pontoProx = l;
              }
            }
          });
          ponto = pontoProx;
          usouProximo = true;
        }
        if (!ponto) {
          quadroFoto.innerHTML = `<div style='color:#c62828;font-size:14px;'>Km não disponível.</div>`;
          quadroFoto.style.display = '';
          return;
        }
        // Coordenada
        let lat = ponto.Latitude || ponto.lat || (ponto.LOCALIZAÇÃO ? ponto.LOCALIZAÇÃO.split(',')[0] : undefined);
        let lng = ponto.Longitude || ponto.lng || (ponto.LOCALIZAÇÃO ? ponto.LOCALIZAÇÃO.split(',')[1] : undefined);
        let coordStr = (lat && lng) ? `${parseFloat(lat).toFixed(6)}, ${parseFloat(lng).toFixed(6)}` : '-';
        // Exibe os dados essenciais + link
        let infoHtml = `<div style='font-size:15px;text-align:left;margin-bottom:6px;'>`;
        if (usouProximo) {
          infoHtml += `<span style='color:#c62828;font-size:13px;'>Km não disponível. Mostrando informações do Km mais próximo: <b>${ponto.Km || ponto['KM '] || '-'}</b></span><br>`;
        }
        infoHtml += `<b>Rodovia:</b> ${rod}<br>`;
        infoHtml += `<b>Km:</b> ${ponto.Km || ponto['KM '] || '-'}<br>`;
        infoHtml += `<b>Município:</b> ${ponto.Município || ponto.MUNICÍPIO || '-'}<br>`;
        infoHtml += `<b>Tipo:</b> ${ponto.Tipo || ponto.TIPO || '-'}<br>`;
        infoHtml += `<b>Coordenada:</b> ${coordStr}`;
        if (lat && lng) {
          infoHtml += ` <a href='https://www.google.com/maps?q=${lat},${lng}' target='_blank' style='color:#1976d2;text-decoration:underline;font-size:14px;'>(Google Maps)</a>`;
        }
        infoHtml += `</div>`;
        quadroFoto.innerHTML = infoHtml;
        quadroFoto.style.display = '';
      });

      // Inicializa filtro Localizar Km com a planilha oficial
      // Aguarda o carregamento do script principal e do PapaParse
      function inicializarSistema() {
        // Verifica se as dependências estão carregadas
        if (typeof Papa === 'undefined' || typeof window.mapa === 'undefined') {
          setTimeout(inicializarSistema, 100);
          return;
        }
        
        // Carrega a planilha oficial
        carregarPlanilhaOficial().then(() => {
          preencherRodoviasFiltroOficial();
          atualizarListaKmOficial();
          const selectRodovia = document.getElementById('filtroRodovia');
          selectRodovia.addEventListener('change', atualizarListaKmOficial);
        }).catch(error => {
          console.error('Erro ao carregar planilha oficial:', error);
        });
      }
      
      // Inicia a inicialização
      inicializarSistema();
      
      // Carrega metadados das rodovias para coordenadas reais
      async function carregarMetadados() {
        try {
          const response = await fetch('assets/data/meta.csv');
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const csvText = await response.text();
          
          return new Promise((resolve) => {
            Papa.parse(csvText, {
              header: true,
              skipEmptyLines: true,
              complete: ({ data }) => {
                // Usa variável global ou cria se não existir
                if (!window.metadadosRodovias) {
                  window.metadadosRodovias = {};
                }
                window.metadadosRodovias = {};
                data.forEach(row => {
                  const rodovia = row.Rodovia?.trim();
                  if (!rodovia) return;
                  
                  const kmInicial = parseFloat(row['Km Inicial']?.replace(',', '.'));
                  const kmFinal = parseFloat(row['Km Final']?.replace(',', '.'));
                  const [latInicial, lngInicial] = row['Lat e Long km Inicial']?.split(',').map(c => parseFloat(c.trim())) || [];
                  const [latFinal, lngFinal] = row['Lat e Long km final']?.split(',').map(c => parseFloat(c.trim())) || [];
                  
                  if (!isNaN(kmInicial) && !isNaN(kmFinal) && !isNaN(latInicial) && !isNaN(lngInicial) && !isNaN(latFinal) && !isNaN(lngFinal)) {
                    if (!window.metadadosRodovias[rodovia]) window.metadadosRodovias[rodovia] = [];
                    window.metadadosRodovias[rodovia].push({
                      kmInicial, kmFinal,
                      coordInicial: { lat: latInicial, lng: lngInicial },
                      coordFinal: { lat: latFinal, lng: lngFinal }
                    });
                  }
                });
                Object.values(window.metadadosRodovias).forEach(trechos => trechos.sort((a, b) => a.kmInicial - b.kmInicial));
                console.log('✅ Metadados carregados:', Object.keys(window.metadadosRodovias).length, 'rodovias');
                resolve();
              }
            });
          });
        } catch (error) {
          console.error('❌ Erro ao carregar metadados:', error);
        }
      }
      
      // Calcula coordenadas reais baseadas na rodovia e Km
      function obterCoordenadaReal(rodovia, km) {
        const metadadosRodovias = window.metadadosRodovias || {};
        
        if (!metadadosRodovias[rodovia]) {
          const rodoviaLimpa = rodovia.replace(/ Vang| Jon| Madri| Obragen| Ellenco| Vale/g, '').trim();
          const possiveisNomes = Object.keys(metadadosRodovias).filter(r => 
            r.includes(rodoviaLimpa) || rodoviaLimpa.includes(r.split(' ')[0] + ' ' + r.split(' ')[1])
          );
          if (possiveisNomes.length === 0) return null;
          rodovia = possiveisNomes[0];
        }
        
        const trechos = metadadosRodovias[rodovia];
        if (!trechos || trechos.length === 0) return null;
        
        const trecho = trechos.find(t => km >= t.kmInicial && km <= t.kmFinal);
        if (!trecho) {
          const trechoProximo = trechos.reduce((prev, curr) => {
            const distPrev = Math.min(Math.abs(km - prev.kmInicial), Math.abs(km - prev.kmFinal));
            const distCurr = Math.min(Math.abs(km - curr.kmInicial), Math.abs(km - curr.kmFinal));
            return distPrev < distCurr ? prev : curr;
          });
          const distInicial = Math.abs(km - trechoProximo.kmInicial);
          const distFinal = Math.abs(km - trechoProximo.kmFinal);
          return distInicial < distFinal ? trechoProximo.coordInicial : trechoProximo.coordFinal;
        }
        
        const progresso = (km - trecho.kmInicial) / (trecho.kmFinal - trecho.kmInicial);
        const lat = trecho.coordInicial.lat + (trecho.coordFinal.lat - trecho.coordInicial.lat) * progresso;
        const lng = trecho.coordInicial.lng + (trecho.coordFinal.lng - trecho.coordInicial.lng) * progresso;
        return { lat, lng };
      }
      // REMOVIDO: Função que usava outras fontes de dados
      // Agora usa apenas PLANILHA BI - OFICIAL.csv
      // REMOVIDO: Carregamento de dados de fontes externas
      // Agora usa apenas PLANILHA BI - OFICIAL.csv local

      // REMOVIDO: Função que usava dados de outras fontes
      // Agora usa atualizarListaKmOficial() que usa apenas PLANILHA BI - OFICIAL.csv

      // REMOVIDO: Event listener que usava dados de outras fontes
      // Agora usa apenas os dados da PLANILHA BI - OFICIAL.csv

      // NOVO: Localizar Km usando PLANILHA BI - OFICIAL.csv
      // Variáveis já declaradas acima

      async function carregarPlanilhaOficial() {
        return new Promise((resolve, reject) => {
        Papa.parse('assets/data/PLANILHA BI - OFICIAL.csv', {
          download: true,
          header: true,
          skipEmptyLines: true,
          delimiter: ';',
          complete: ({ data }) => {
            dadosPlanilhaOficial = data;
            rodoviasPlanilha = [...new Set(data.map(l => l.SP?.trim()).filter(Boolean))];
            kmsPorRodovia = {};
            data.forEach(linha => {
              const rod = linha.SP?.trim();
              const kmStr = linha['KM ']?.replace(',', '.');
              const km = parseFloat(kmStr);
              if (!rod || isNaN(km)) return;
              if (!kmsPorRodovia[rod]) kmsPorRodovia[rod] = [];
              kmsPorRodovia[rod].push({
                ...linha,
                km,
                lat: parseFloat((linha.LOCALIZAÇÃO||'').split(',')[0]),
                lng: parseFloat((linha.LOCALIZAÇÃO||'').split(',')[1])
              });
            });
            // Ordena kms
            Object.values(kmsPorRodovia).forEach(arr => arr.sort((a,b)=>a.km-b.km));
            // Preenche rodovias e kms após o carregamento
            preencherRodoviasFiltroOficial();
            atualizarListaKmOficial();
            resolve();
          },
          error: reject
        });
        });
      }

      function preencherRodoviasFiltroOficial() {
        const select = document.getElementById('filtroRodovia');
        select.innerHTML = '<option value="">Rodovia</option>';
        if (!Array.isArray(dadosPlanilhaOficial)) {
          console.warn('dadosPlanilhaOficial não é array');
          return;
        }
        // Gera lista única de rodovias da coluna SP, sem duplicidades e limpando espaços extras
        const rodoviasUnicas = [...new Set(dadosPlanilhaOficial.map(l => (l.SP || '').toString().trim()).filter(r => r.length > 0))].sort();
        console.log('Rodovias encontradas:', rodoviasUnicas);
        rodoviasUnicas.forEach(r => {
          const opt = document.createElement('option');
          opt.value = r;
          opt.textContent = r;
          select.appendChild(opt);
        });
      }

      function atualizarListaKmOficial() {
        const rod = document.getElementById('filtroRodovia').value;
        // Filtra os kms correspondentes à rodovia selecionada
        const arr = dadosPlanilhaOficial.filter(l => (l.SP?.trim() === rod) && l['KM '] && !isNaN(parseFloat(l['KM '].replace(',', '.'))));
        const kmSelect = document.getElementById('filtroKm');
        kmSelect.innerHTML = '';
        arr.forEach(p => {
          const kmNum = parseFloat(p['KM '].replace(',', '.'));
          if (!isNaN(kmNum)) {
            const opt = document.createElement('option');
            opt.value = kmNum.toFixed(3);
            opt.textContent = kmNum.toFixed(3);
            kmSelect.appendChild(opt);
          }
        });
        kmSelect.disabled = !arr.length;
        document.getElementById('filtroKmBtn').disabled = !arr.length;
      }

      document.getElementById('filtroRodovia').addEventListener('change', atualizarListaKmOficial);

      document.getElementById('filtroKmBtn').addEventListener('click', function() {
        const rod = document.getElementById('filtroRodovia').value;
        const kmSelect = document.getElementById('filtroKm');
        const arr = kmsPorRodovia[rod] || [];
        const link = document.getElementById('filtroKmLink');
        const msgKmProximo = document.getElementById('msgKmProximo');
        const quadroFoto = document.getElementById('quadroFotoKm');
        quadroFoto.style.display = 'none';
        link.classList.remove('active');
        msgKmProximo.style.display = 'none';
        if (!rod || !arr.length) {
          alert('Selecione uma rodovia e um Km válido!');
          return;
        }
        let km = parseFloat(kmSelect.value.replace(',', '.'));
        let ponto = arr.find(p => p.km.toFixed(3) === km.toFixed(3));
        let usouProximo = false;
        if (!ponto) {
          ponto = arr.reduce((prev, curr) => Math.abs(curr.km - km) < Math.abs(prev.km - km) ? curr : prev, arr[0]);
          km = ponto.km;
          usouProximo = true;
        }
        if (usouProximo) {
          msgKmProximo.textContent = `Km não disponível. Mostrando informações do Km mais próximo: ${ponto.km.toFixed(3)}`;
          msgKmProximo.style.display = '';
        }
        // Mostra marcador e link
        if (window.filtroMarker && window.mapa) window.mapa.removeLayer(window.filtroMarker);
        if (window.mapa) {
          const customIcon = L.icon({
            iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-red.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            shadowSize: [41, 41]
          });
          window.filtroMarker = L.marker([ponto.lat, ponto.lng], { pane: "markerPane", icon: customIcon }).addTo(window.mapa);
          window.mapa.setView([ponto.lat, ponto.lng], 15, { animate: true });
          setTimeout(() => { window.filtroMarker.setZIndexOffset(1000); }, 100);
        }
        link.href = `https://www.google.com/maps?q=${ponto.lat},${ponto.lng}`;
        link.textContent = `Ver no Google Maps (${ponto.lat.toFixed(6)}, ${ponto.lng.toFixed(6)})`;
        link.classList.add('active');
        // Mostra quadro de informações detalhadas, exibindo apenas os dados essenciais
        let infoHtml = `<div style='font-size:15px;text-align:left;margin-bottom:6px;'>`;
        if (usouProximo) {
          infoHtml += `<span style='color:#c62828;font-size:13px;'>Km não disponível. Mostrando informações do Km mais próximo: <b>${ponto.km !== undefined ? ponto.km.toFixed(3) : '-'}</b></span><br>`;
        }
        infoHtml += `<b>Rodovia:</b> ${ponto.SP || rod || '-'}<br>`;
        infoHtml += `<b>Km:</b> ${ponto.km !== undefined ? ponto.km.toFixed(3) : '-'}<br>`;
        infoHtml += `<b>Município:</b> ${ponto.MUNICÍPIO || ponto.municipio || '-'}<br>`;
        infoHtml += `<b>Tipo:</b> ${ponto.TIPO || ponto.tipo || '-'}<br>`;
        let latFinal = ponto.lat !== undefined ? ponto.lat : undefined;
        let lngFinal = ponto.lon !== undefined ? ponto.lon : ponto.lng !== undefined ? ponto.lng : undefined;
        let coordStr = (latFinal !== undefined && lngFinal !== undefined) ? `${parseFloat(latFinal).toFixed(6)}, ${parseFloat(lngFinal).toFixed(6)}` : '-';
        let linkGoogle = (latFinal !== undefined && lngFinal !== undefined) ? `<a href='https://www.google.com/maps?q=${latFinal},${lngFinal}' target='_blank' style='color:#1976d2;text-decoration:underline;font-size:14px;'>(Google Maps)</a>` : '';
        infoHtml += `<b>Coordenada:</b> ${coordStr} ${linkGoogle}<br>`;
        infoHtml += `</div>`;
        quadroFoto.innerHTML = infoHtml;
        quadroFoto.style.display = '';
      });

      // Inicializa filtro Localizar Km com a planilha oficial
      // Sempre mostrar todas as rodovias e Kms da PLANILHA BI - OFICIAL.csv, sem filtro
function aguardarPapaParse() {
  if (typeof Papa === 'undefined') {
    setTimeout(aguardarPapaParse, 100);
    return;
  }
  carregarPlanilhaOficial().then(() => {
    const selectRodovia = document.getElementById('filtroRodovia');
    selectRodovia.addEventListener('change', atualizarListaKmOficial);
    preencherRodoviasFiltroOficial();
  });
}
aguardarPapaParse();

// ====== SISTEMA DE GEOLOCALIZAÇÃO EM TEMPO REAL ======
let geolocalizacaoAtiva = false;
let watchId = null;

// Adicionar marcador do usuário
let marcadorUsuario = null;
let circuloPrecisao = null;

function atualizarPosicaoUsuario(position) {
  const lat = position.coords.latitude;
  const lng = position.coords.longitude;
  const precisao = position.coords.accuracy;

  if (!window.mapa) {
    setTimeout(() => atualizarPosicaoUsuario(position), 100);
    return;
  }

  // Remove marcadores anteriores
  if (marcadorUsuario) {
    marcadorUsuario.setMap(null);
  }
  if (circuloPrecisao) {
    circuloPrecisao.setMap(null);
  }

  // Adiciona marcador do usuário
  marcadorUsuario = new google.maps.Marker({
    position: { lat, lng },
    map: window.mapa,
    icon: {
      url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
      scaledSize: new google.maps.Size(32, 32)
    }
  });

  // Adiciona círculo de precisão
  circuloPrecisao = new google.maps.Circle({
    strokeColor: '#4285f4',
    strokeOpacity: 0.5,
    strokeWeight: 2,
    fillColor: '#4285f4',
    fillOpacity: 0.1,
    map: window.mapa,
    center: { lat, lng },
    radius: precisao
  });

  // Atualiza informações na interface
  document.getElementById('geoStatus').textContent = `Localização ativa (±${Math.round(precisao)}m)`
  document.getElementById('geoCoordenadas').textContent = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
}

// Função para adicionar GeoJSON no Google Maps
function adicionarGeoJSONNoMapa(geojson, cor = "#1976d2") {
  if (!window.mapa) return;
  window.mapa.data.addGeoJson(geojson);
  window.mapa.data.setStyle({
    strokeColor: cor,
    strokeWeight: 3,
    fillColor: cor,
    fillOpacity: 0.18
  });
}

// Lista de shapefiles
const SHAPEFILES = [
  { nome: 'RC_2.1.zip', cor: '#e53935' }, // vermelho
  { nome: 'RC_2.2.zip', cor: '#43a047' }, // verde
  { nome: 'RC_2.4.zip', cor: '#1e88e5' }, // azul
  { nome: 'RC_2.5.zip', cor: '#fbc02d' }, // amarelo
  { nome: 'RC_2.6_2.8.zip', cor: '#8e24aa' }, // roxo
  { nome: 'RC_2.7.zip', cor: '#00897b' } // teal
];

// Carregar todos os shapefiles
SHAPEFILES.forEach(({ nome, cor }) => {
  shp(`assets/data/${nome}`).then(function(geojson) {
    adicionarGeoJSONNoMapa(geojson, cor);
  });
});

// Carregar KMZ
fetch('assets/data/malha_dr02.kmz')
  .then(res => res.arrayBuffer())
  .then(buffer => JSZip.loadAsync(buffer))
  .then(zip => {
    const kmlFile = Object.keys(zip.files).find(name => name.endsWith('.kml'));
    return zip.files[kmlFile].async('string');
  })
  .then(kmlText => {
    const kmlDom = new DOMParser().parseFromString(kmlText, 'text/xml');
    const geojson = toGeoJSON.kml(kmlDom);
    adicionarGeoJSONNoMapa(geojson, "#1976d2"); // azul padrão
  });

  // Inicializa geolocalização
  function inicializarGeolocalizacao() {
    if (!navigator.geolocation) {
      console.warn('Geolocalização não é suportada neste navegador.');
      return;
    }
    geolocalizacaoAtiva = true;
    watchId = navigator.geolocation.watchPosition(
      atualizarPosicaoUsuario,
      (error) => {
        console.error('Erro na geolocalização:', error);
        document.getElementById('geoStatus').textContent = 'Erro na localização';
      },
      {
        enableHighAccuracy: true,
        maximumAge: 10000,
        timeout: 5000
      }
    );
    document.getElementById('geoStatus').textContent = 'Localizando...';
  }

  // Para a geolocalização
  function pararGeolocalizacao() {
    geolocalizacaoAtiva = false;
    if (watchId !== null) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }
    if (marcadorUsuario) {
      marcadorUsuario.setMap(null);
      marcadorUsuario = null;
    }
    if (circuloPrecisao) {
      circuloPrecisao.setMap(null);
      circuloPrecisao = null;
    }
    document.getElementById('geoStatus').textContent = 'Clique para ativar localização';
  }

  // Alterna geolocalização ao clicar no botão
  document.getElementById('btnGeolocalizacao').addEventListener('click', () => {
    if (geolocalizacaoAtiva) {
      pararGeolocalizacao();
    } else {
      inicializarGeolocalizacao();
    }
  });

  // Atualiza visibilidade dos círculos de acordo com o zoom
  function atualizarVisibilidadeCirculos() {
    if (!window.mapa) return;
    const zoom = window.mapa.getZoom();
    const visivel = zoom >= 8; // Ajuste o nível de zoom conforme necessário

    if (circuloPrecisao) {
      circuloPrecisao.setMap(visivel ? window.mapa : null);
    }
  }

  // Atualiza a visibilidade ao iniciar
  google.maps.event.addListenerOnce(window.mapa, 'idle', atualizarVisibilidadeCirculos);
  </script>
</body>
</html>
